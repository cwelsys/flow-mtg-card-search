#!/bin/sh

# Auto-increment patch version in plugin.json before each commit
# Only bumps version when meaningful files are changed

PLUGIN_FILE="plugin.json"

# Get list of staged files (excluding plugin.json itself to avoid circular dependency)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v "^$PLUGIN_FILE$")

# Files/directories that should trigger a version bump
# These are the files that actually affect plugin functionality
MEANINGFUL_PATTERNS="^src/|^package\.json$|^SettingsTemplate\.yaml$|^img/"

# Check if any staged files match meaningful patterns
MEANINGFUL_CHANGES=$(echo "$STAGED_FILES" | grep -E "$MEANINGFUL_PATTERNS")

if [ -z "$MEANINGFUL_CHANGES" ]; then
    # No meaningful changes, skip version bump
    exit 0
fi

# Meaningful changes detected, proceed with version bump
if [ ! -f "$PLUGIN_FILE" ]; then
    echo "Warning: $PLUGIN_FILE not found, skipping version bump"
    exit 0
fi

# Read current version
CURRENT_VERSION=$(node -p "require('./$PLUGIN_FILE').Version")

if [ -z "$CURRENT_VERSION" ]; then
    echo "Warning: Could not read version from $PLUGIN_FILE"
    exit 0
fi

# Split version into parts (assuming semver: major.minor.patch)
IFS='.' read -r MAJOR MINOR PATCH << EOF
$CURRENT_VERSION
EOF

# Increment patch version
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Update plugin.json with new version
node -e "
const fs = require('fs');
const plugin = JSON.parse(fs.readFileSync('$PLUGIN_FILE', 'utf8'));
plugin.Version = '$NEW_VERSION';
fs.writeFileSync('$PLUGIN_FILE', JSON.stringify(plugin, null, '\t') + '\n');
"

# Stage the updated plugin.json
git add "$PLUGIN_FILE"

echo "✓ Auto-bumped version: $CURRENT_VERSION → $NEW_VERSION"

exit 0
